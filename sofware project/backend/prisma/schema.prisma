// CareConnect Database Schema - Normalized MySQL with Prisma
// Generator configuration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  STUDENT
  DOCTOR
  NURSE
  ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum EmergencyPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum EmergencyStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  CANCELLED
}

// ============================================================================
// USER & PROFILES
// ============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(STUDENT)
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Profile relations (one-to-one)
  studentProfile StudentProfile?
  doctorProfile  DoctorProfile?

  // Relations (one-to-many)
  appointments        Appointment[]
  doctorAppointments  Appointment[]       @relation("DoctorAppointments")
  medicalRecords      MedicalRecord[]
  doctorRecords       MedicalRecord[]     @relation("DoctorRecords")
  emergencyRequests   EmergencyRequest[]
  assignedEmergencies EmergencyRequest[]  @relation("AssignedStaff")
  chatMessages        ChatMessage[]
  auditLogs           AuditLog[]
  createdAuditLogs    AuditLog[]          @relation("CreatedByUser")

  // Indexes for performance
  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([createdAt])
  @@map("users")
}

model StudentProfile {
  id               String    @id @default(cuid())
  userId           String    @unique
  studentId        String    @unique
  dateOfBirth      DateTime?
  address          String?   @db.Text
  emergencyContact String?
  emergencyPhone   String?
  medicalHistory   String?   @db.Text
  allergies        String?   @db.Text
  bloodType        String?
  insuranceNumber  String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Strict foreign key with CASCADE delete
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([studentId])
  @@map("student_profiles")
}

model DoctorProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  licenseNumber  String   @unique
  specialty      String
  qualifications String?  @db.Text
  availableHours String?  @db.Text
  bio            String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Strict foreign key with CASCADE delete
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([licenseNumber])
  @@index([specialty])
  @@map("doctor_profiles")
}

// ============================================================================
// APPOINTMENTS
// ============================================================================

model Appointment {
  id         String            @id @default(cuid())
  userId     String
  doctorId   String?
  serviceId  String?
  date       DateTime
  duration   Int               @default(30) // in minutes
  status     AppointmentStatus @default(PENDING)
  reason     String?           @db.Text
  notes      String?           @db.Text
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  // Relations with CASCADE delete
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  doctor User?  @relation("DoctorAppointments", fields: [doctorId], references: [id], onDelete: SetNull)
  files  AppointmentFile[]

  // Indexes for queries and performance
  @@index([userId])
  @@index([doctorId])
  @@index([date])
  @@index([status])
  @@index([createdAt])
  @@index([userId, date])
  @@index([doctorId, date])
  @@map("appointments")
}

model AppointmentFile {
  id            String   @id @default(cuid())
  appointmentId String
  fileName      String
  fileUrl       String   @db.VarChar(500)
  mimeType      String
  size          Int      // in bytes
  createdAt     DateTime @default(now())

  // Strict foreign key with CASCADE delete
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([createdAt])
  @@map("appointment_files")
}

// ============================================================================
// MEDICAL RECORDS (ENCRYPTED)
// ============================================================================

model MedicalRecord {
  id            String   @id @default(cuid())
  userId        String
  doctorId      String?
  encryptedData String   @db.LongText // Base64-encoded encrypted JSON
  keyId         String?  // Reference to encryption key
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations with CASCADE delete
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  doctor     User?             @relation("DoctorRecords", fields: [doctorId], references: [id], onDelete: SetNull)
  files      MedicalRecordFile[]
  auditLogs  AuditLog[]

  // Indexes for queries
  @@index([userId])
  @@index([doctorId])
  @@index([createdAt])
  @@index([keyId])
  @@index([userId, createdAt])
  @@map("medical_records")
}

model MedicalRecordFile {
  id            String   @id @default(cuid())
  recordId      String
  fileName      String
  encryptedData String   @db.LongText // Base64-encoded encrypted file
  mimeType      String
  size          Int      // in bytes
  keyId         String?
  createdAt     DateTime @default(now())

  // Strict foreign key with CASCADE delete
  record MedicalRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@index([recordId])
  @@index([createdAt])
  @@map("medical_record_files")
}

// ============================================================================
// EMERGENCY REQUESTS
// ============================================================================

model EmergencyRequest {
  id          String            @id @default(cuid())
  userId      String
  assignedTo  String?
  priority    EmergencyPriority @default(MEDIUM)
  status      EmergencyStatus   @default(PENDING)
  description String            @db.Text
  location    String?
  phone       String?
  notes       String?           @db.Text
  resolvedAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations with CASCADE delete
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  staff User?  @relation("AssignedStaff", fields: [assignedTo], references: [id], onDelete: SetNull)

  // Indexes for performance
  @@index([userId])
  @@index([assignedTo])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([status, priority])
  @@index([assignedTo, status])
  @@map("emergency_requests")
}

// ============================================================================
// CHAT MESSAGES
// ============================================================================

model ChatMessage {
  id             String   @id @default(cuid())
  userId         String
  message        String   @db.Text
  response       String?  @db.Text
  isFromBot      Boolean  @default(false)
  conversationId String?
  createdAt      DateTime @default(now())

  // Strict foreign key with CASCADE delete
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([conversationId])
  @@index([createdAt])
  @@index([userId, conversationId])
  @@index([createdAt, conversationId])
  @@map("chat_messages")
}

// ============================================================================
// AUDIT LOGS
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  // User who performed the action
  createdById String?  // User who created the log entry (for record creation)
  action     String   // e.g., "CREATE_RECORD", "VIEW_RECORD", "UPDATE_APPOINTMENT"
  resource   String   // e.g., "MedicalRecord", "Appointment"
  resourceId String?
  ipAddress  String?
  userAgent  String?  @db.VarChar(500)
  metadata   String?  @db.Text // JSON string for additional data
  createdAt  DateTime @default(now())

  // Relations (SetNull on delete to preserve audit trail)
  user         User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdBy    User?           @relation("CreatedByUser", fields: [createdById], references: [id], onDelete: SetNull)
  medicalRecord MedicalRecord? @relation(fields: [resourceId], references: [id], onDelete: SetNull)

  // Indexes for audit queries
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([resourceId])
  @@index([createdAt])
  @@index([resource, resourceId])
  @@index([createdAt, action])
  @@map("audit_logs")
}
